<!DOCTYPE html>
<html lang="en">


<!--=========================================================================
NOBLE ARCHITECTURE  - TRUEVISION 3D MODEL VIEWER
=============================================================================

FILE        :  Index.html
DIRECTORY   :  ./
FILE URL    :  ((TBC_Currently_locally_And_Not_Hosted_On_Web_Yet))
NAMESPACE   :  TrueVision3D
MODULE      :  TrueVision3D Core Application
AUTHOR      :  Adam Noble - Noble Architecture
PURPOSE     :  3D Model Viewer for Architectural Presentations using Babylon.js
CREATED     :  2025

DESCRIPTION:
- Web-based 3D model viewer built with Babylon.js for architectural visualization
- Supports GLB format models with real-time lighting and shadow calculations
- Features multiple camera navigation modes configurable per client
- Includes waypoint navigation system for curated architectural tours
- Interactive sun positioning based on time of day and geographical coordinates
- Automatic material detection and enhancement for glass and metal surfaces
- Responsive interface with toolbar controls and loading states
- Optimized for Noble Architecture client presentations and design reviews

=============================================================================
-->


<!-- ----------------------------------------------------------------- -->
<!-- REGION | HTML Document Head Configuration                         -->
<!-- ----------------------------------------------------------------- -->

<head>
    <meta charset="UTF-8" />
    <meta name="file_name" content="index.html">
    <meta name="app_name" content="TrueVision">
    <meta name="version" content="1.1.1"> <!-- Version tracking for deployment   -->
    <meta name="version_notes" content="Added HDRI environmental lighting system with configuration-driven control">
    <title>True Vision 3D by Noble Architecture – Pre Beta Version</title>

    <!-- ----------------------------------------------------------------- -->
    <!-- FAVICON | Application Icon Configuration                          -->
    <!-- ----------------------------------------------------------------- -->
    <link rel="icon" type="image/svg+xml"
        href="https://www.noble-architecture.com/assets/AD05_-_LIBR_-_Common_-_Icons-and-favicons/AD05_01_-_NA_Favicon_-_SVG-h50mm.svg">

    <!-- ----------------------------------------------------------------- -->
    <!-- STYLESHEET | Core CSS Stylesheet for TrueVision Core Application  -->
    <!-- ----------------------------------------------------------------- -->
    <link rel="stylesheet" href="StyleSheet_TrueVisionCoreAppStyles.css">

    <!-- ----------------------------------------------------------------- -->
    <!-- REGION | External JavaScript Library Dependencies                 -->
    <!-- ----------------------------------------------------------------- -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script> <!--  Core Babylon.js 3D engine        -->
    <script src="./20_Dev_External-Scripts/babylon.glTF2FileLoader.js"></script>
    <!--  .Glb  /  glTF model loader       -->
    <script src="RenderEffect_SsaoAmbientOcclusionEffect.js"></script> <!--  SSAO Ambient Occlusion Effect    -->
    <script src="UiMenu_NavModeButtonManager.js"></script> <!--  UI Menu Navigation Mode Manager  -->
    <!-- endregion -------------------------------------------------------- -->

    <!-- ----------------------------------------------------------------- -->
    <!-- REGION | Application Configuration and Core JavaScript Modules    -->
    <!-- ----------------------------------------------------------------- -->

    <!-- Module Dependency Manager - MUST BE FIRST -->
    <script src="ModuleDependencyManager.js"></script>

    <script>
        // Create global namespace
        window.TrueVision3D = window.TrueVision3D || {};

        // Load application configuration with promise for synchronization
        window.TrueVision3D.configLoadPromise = (async function () {
            try {
                const response = await fetch('Data_-_MainAppConfig.json');
                if (response.ok) {
                    window.TrueVision3D.AppConfig = await response.json();
                    console.log('App configuration loaded successfully:', window.TrueVision3D.AppConfig);

                    // MARK CONFIG AS LOADED
                    if (window.TrueVision3D.ModuleDependencyManager) {
                        window.TrueVision3D.ModuleDependencyManager.markModuleLoaded('config');
                    }

                    return true;
                } else {
                    console.error('Failed to load app configuration:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('Error loading app configuration:', error);
                return false;
            }
        })();
    </script>

    <!-- Core Application JavaScript Modules - Loaded in priority order -->
    <script src="ModelLoader_CdnProgressiveLoader.js"></script>
    <script src="Materials_TextureSubstitutionAutomationLogic.js"></script>
    <script src="SceneConfig_HdriLightingLogic.js"></script>
    <script src="SceneConfig_SolarOrientationControlLogic.js"></script>

    <!-- Replace the single RenderingPipeline script with conditional loading -->
    <script>
        // After config is loaded, determine which rendering pipeline to use
        window.TrueVision3D.configLoadPromise.then(success => {
            console.log("🔍 Config promise resolved, success:", success);
            console.log("🔍 TrueVision3D.AppConfig available:", !!window.TrueVision3D.AppConfig);

            if (success && window.TrueVision3D.AppConfig) {
                const renderConfig = window.TrueVision3D.AppConfig.AppConfig.RenderPipelineConfig;
                console.log("🔍 RenderPipelineConfig:", renderConfig);

                // HELPER FUNCTION | Enhanced Mobile Detection
                // ---------------------------------------------------------------
                function detectMobileDevice() {
                    // Check user agent (primary method)
                    const userAgentCheck = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                    // Check for touch support (secondary method)
                    const touchCheck = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

                    // Check screen size (tertiary method)
                    const screenCheck = window.innerWidth <= 768 || window.innerHeight <= 768;

                    // Check for mobile-specific features
                    const mobileFeatures = window.orientation !== undefined;

                    // iPad Pro and tablets in desktop mode detection
                    const isIpadOS = (navigator.platform === 'MacIntel' && touchCheck && navigator.maxTouchPoints > 1);

                    // Combine checks with weighted decision
                    if (userAgentCheck || isIpadOS) return true;
                    if (touchCheck && screenCheck) return true;
                    if (mobileFeatures && touchCheck) return true;

                    return false;
                }
                // ---------------------------------------------------------------

                const isMobile = detectMobileDevice();
                let scriptToLoad = null;

                // ROBUST CONFIGURATION CHECKING WITH FALLBACKS
                // Handle both old and new property name formats
                const pcEnabled = renderConfig.RenderPipeline_PcEnabled !== undefined
                    ? renderConfig.RenderPipeline_PcEnabled
                    : renderConfig.PC;

                const mobileEnabled = renderConfig.RenderPipeline_MobileEnabled !== undefined
                    ? renderConfig.RenderPipeline_MobileEnabled
                    : renderConfig.Mobile;

                const fallbackToPcOnMobileFail = renderConfig.RenderPipeline_FallbackToPcOnMobileFail !== undefined
                    ? renderConfig.RenderPipeline_FallbackToPcOnMobileFail
                    : true; // Default to true for robustness

                const pcFile = renderConfig.RenderPipeline_PcFile || 'RenderingPipeline__TrueVision3DCore__PcVersion.js';
                const mobileFile = renderConfig.RenderPipeline_MobileFile || 'RenderingPipeline__TrueVision3DCore__MobileVersion.js';

                // DETERMINE PRIMARY AND FALLBACK SCRIPTS
                if (isMobile) {
                    if (mobileEnabled) {
                        scriptToLoad = mobileFile;
                        console.log('Device detected as mobile - loading mobile pipeline:', scriptToLoad);
                    } else if (pcEnabled && fallbackToPcOnMobileFail) {
                        // Mobile device but mobile disabled - try PC version as fallback
                        scriptToLoad = pcFile;
                        console.warn('Mobile device detected but mobile pipeline disabled - attempting PC pipeline fallback');
                    }
                } else {
                    if (pcEnabled) {
                        scriptToLoad = pcFile;
                        console.log('Device detected as PC - loading PC pipeline:', scriptToLoad);
                    } else if (mobileEnabled) {
                        // PC but PC disabled - try mobile version as fallback
                        scriptToLoad = mobileFile;
                        console.warn('PC detected but PC pipeline disabled - attempting mobile pipeline fallback');
                    }
                }

                // CHECK IF ANY PIPELINE IS AVAILABLE
                if (!scriptToLoad) {
                    console.error('No rendering pipeline enabled in configuration');
                    console.error('Configuration state:', {
                        pcEnabled,
                        mobileEnabled,
                        isMobile,
                        fallbackToPcOnMobileFail
                    });

                    document.body.innerHTML = `
                        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; padding: 20px; text-align: center; background: #f0f0f0; font-family: Arial, sans-serif;">
                            <h1 style="color: #172b3a; margin-bottom: 20px;">Configuration Error</h1>
                            <p style="color: #1e1e1e; max-width: 600px; line-height: 1.6; margin-bottom: 20px;">
                                No rendering pipeline is enabled in the configuration. Please contact support.
                            </p>
                            <div style="background: #fff; padding: 15px; border-radius: 5px; border-left: 4px solid #cd0000; margin-bottom: 20px;">
                                <h3 style="color: #cd0000; margin: 0 0 10px 0;">Debug Information</h3>
                                <p style="margin: 0; font-size: 12px; color: #666;">
                                    Device: ${isMobile ? 'Mobile' : 'Desktop'}<br>
                                    PC Pipeline: ${pcEnabled ? 'Enabled' : 'Disabled'}<br>
                                    Mobile Pipeline: ${mobileEnabled ? 'Enabled' : 'Disabled'}<br>
                                    Fallback Allowed: ${fallbackToPcOnMobileFail ? 'Yes' : 'No'}<br>
                                    User Agent: ${navigator.userAgent}
                                </p>
                            </div>
                            <button onclick="location.reload()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Reload Page
                            </button>
                        </div>
                    `;
                    return;
                }

                // LOAD THE SELECTED PIPELINE WITH ENHANCED ERROR HANDLING
                const script = document.createElement('script');
                script.src = scriptToLoad;
                script.async = false; // Ensure synchronous loading

                script.onload = () => {
                    console.log('✅ Rendering pipeline loaded successfully:', scriptToLoad);
                    console.log('🔍 window.TrueVision3D.RenderingPipeline available:', !!window.TrueVision3D.RenderingPipeline);
                    if (window.TrueVision3D.RenderingPipeline) {
                        console.log('🔍 RenderingPipeline methods:', Object.keys(window.TrueVision3D.RenderingPipeline));
                    }

                    // Add comprehensive device info to TrueVision3D namespace for debugging
                    window.TrueVision3D.deviceInfo = {
                        detectedAsMobile: isMobile,
                        loadedPipeline: scriptToLoad,
                        userAgent: navigator.userAgent,
                        touchSupport: ('ontouchstart' in window) || (navigator.maxTouchPoints > 0),
                        screenSize: `${window.innerWidth}x${window.innerHeight}`,
                        devicePixelRatio: window.devicePixelRatio,
                        platform: navigator.platform,
                        configState: {
                            pcEnabled,
                            mobileEnabled,
                            fallbackToPcOnMobileFail
                        }
                    };

                    // Notify that the rendering pipeline is ready
                    window.dispatchEvent(new CustomEvent('renderingPipelineLoaded'));
                    console.log('🔔 Rendering pipeline loaded event dispatched');
                };

                script.onerror = (error) => {
                    console.error('❌ Failed to load rendering pipeline script:', scriptToLoad);
                    console.error('Error details:', error);

                    // ATTEMPT FALLBACK IF MOBILE PIPELINE FAILS
                    if (isMobile && scriptToLoad === mobileFile && pcEnabled && fallbackToPcOnMobileFail) {
                        console.warn('🔄 Attempting PC pipeline fallback after mobile pipeline failure');

                        const fallbackScript = document.createElement('script');
                        fallbackScript.src = pcFile;
                        fallbackScript.async = false;

                        fallbackScript.onload = () => {
                            console.log('✅ PC pipeline fallback loaded successfully');
                            window.TrueVision3D.deviceInfo = {
                                detectedAsMobile: isMobile,
                                loadedPipeline: pcFile,
                                fallbackUsed: true,
                                originalAttempt: mobileFile,
                                userAgent: navigator.userAgent,
                                touchSupport: ('ontouchstart' in window) || (navigator.maxTouchPoints > 0),
                                screenSize: `${window.innerWidth}x${window.innerHeight}`
                            };
                            window.dispatchEvent(new CustomEvent('renderingPipelineLoaded'));
                        };

                        fallbackScript.onerror = () => {
                            console.error('❌ PC pipeline fallback also failed');
                            showLoadingError(pcFile, 'Both mobile and PC pipelines failed to load');
                        };

                        document.head.appendChild(fallbackScript);
                    } else {
                        showLoadingError(scriptToLoad, 'Failed to load rendering pipeline');
                    }
                };

                // HELPER FUNCTION | Show Loading Error Page
                function showLoadingError(failedScript, message) {
                    document.body.innerHTML = `
                        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; padding: 20px; text-align: center; background: #f0f0f0; font-family: Arial, sans-serif;">
                            <h1 style="color: #172b3a; margin-bottom: 20px;">Loading Error</h1>
                            <p style="color: #1e1e1e; max-width: 600px; line-height: 1.6; margin-bottom: 20px;">
                                ${message}. Please refresh the page or contact support if the problem persists.
                            </p>
                            <div style="background: #fff; padding: 15px; border-radius: 5px; border-left: 4px solid #cd0000; margin-bottom: 20px;">
                                <h3 style="color: #cd0000; margin: 0 0 10px 0;">Technical Details</h3>
                                <p style="margin: 0; font-size: 12px; color: #666;">
                                    Failed to load: ${failedScript}<br>
                                    Device: ${isMobile ? 'Mobile' : 'Desktop'}<br>
                                    Browser: ${navigator.userAgent}
                                </p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="location.reload()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    Reload Page
                                </button>
                                <button onclick="localStorage.clear(); location.reload()" style="padding: 10px 20px; background: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    Clear Cache & Reload
                                </button>
                            </div>
                        </div>
                    `;
                }

                console.log('🚀 Attempting to load rendering pipeline:', scriptToLoad);
                document.head.appendChild(script);
            } else {
                console.error('❌ Configuration failed to load or is invalid');
                document.body.innerHTML = `
                    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; padding: 20px; text-align: center; background: #f0f0f0; font-family: Arial, sans-serif;">
                        <h1 style="color: #172b3a;">Configuration Error</h1>
                        <p style="color: #1e1e1e; max-width: 600px; line-height: 1.6;">
                            Unable to load application configuration. Please check your internet connection and try again.
                        </p>
                        <button onclick="location.reload()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Reload Page
                        </button>
                    </div>
                `;
            }
        }).catch(error => {
            console.error('❌ Critical error in configuration loading:', error);
            document.body.innerHTML = `
                <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; padding: 20px; text-align: center; background: #f0f0f0; font-family: Arial, sans-serif;">
                    <h1 style="color: #172b3a;">Critical Error</h1>
                    <p style="color: #1e1e1e; max-width: 600px; line-height: 1.6;">
                        A critical error occurred while loading the application. Please contact support.
                    </p>
                    <p style="color: #666; font-size: 12px; margin-top: 20px;">
                        Error: ${error.message}
                    </p>
                </div>
            `;
        });
    </script>

    <!-- Dev Tools Manager - Load before navigation systems -->
    <script src="DevTools_DebugMarkersManager.js"></script>

    <!-- Navigation Mode Scripts - Loaded in priority order -->
    <script src="NavMode_WaypointNavigationSystemLogic.js"></script>
    <script src="NavMode_WalkNavigationSystemLogic.js"></script>
    <script src="NavMode_OrbitNavigationSystemLogic.js"></script>
    <script src="NavMode_FlyNavigationSystemLogic.js"></script>

    <!-- Application Core Manager - Loaded last to coordinate all modules -->
    <script src="ApplicationCore_TrueVision3DManager.js"></script>

    <!-- endregion ----------------------------------------------------------------- -->

</head>
<!-- endregion ----------------------------------------------------------------- -->


<body>
    <!-- ----------------------------------------------------------------- -->
    <!-- REGION | User Interface HTML Layout & Elements                   -->
    <!-- ----------------------------------------------------------------- -->
    <div id="app-container">

        <!-- ----------------------------------------------------------------- -->
        <!-- UI MENU | Application Header with Hamburger Menu and Branding    -->
        <!-- ----------------------------------------------------------------- -->
        <div id="header">
            <button id="toggleToolbarBtn">☰</button> <!-- Hamburger menu toggle -->
            <span id="app-title" style="padding-left: 10px;">True Vision 3D
                <span class="version-text" style="font-size: 12px; color: #656565;">- Pre Beta Version 1.3.0</span>
            </span> <!-- Application title with version -->
            <img src="https://www.noble-architecture.com/assets/NA03_-_LIBR_-_NA-Site_-_Core-Brand-Image-Assets/NA03_01_-_PNG_-_NA_Company_Logo_-_w2048_x_h500px.png"
                alt="Noble Architecture Logo"> <!-- Company logo on right  -->
        </div>
        <!-- ---------------------------------------------------------------- -->

        <!-- ----------------------------------------------------------------- -->
        <!-- UI MENU | Menu Tutorial Overlay for First-Time Users             -->
        <!-- ----------------------------------------------------------------- -->
        <div id="menu-tutorial-overlay">
            <div id="menu-pointer-arrow"></div> <!-- Arrow pointing to menu -->
            <div id="menu-tutorial-text">Press Here To Open / Hide The Tools Menu</div> <!-- Tutorial message     -->
        </div>
        <!-- ---------------------------------------------------------------- -->

        <!-- ----------------------------------------------------------------- -->
        <!-- UI MENU | Interactive Toolbar with Camera and Lighting Controls  -->
        <!-- ----------------------------------------------------------------- -->
        <div id="toolbar">
            <div style="margin-top: -15px;"></div> <!-- Top spacing adjustment -->

            <label for="resetViewBtn" style="margin-top: 20px; margin-bottom: 10px;">View Controls</label>
            <button class="tool-button" id="resetViewBtn">Reset View</button> <!-- Reset camera position  -->

            <label style="margin-top: 20px; margin-bottom: 10px;">Navigation Modes</label>
            <button class="tool-button nav-mode-btn" id="waypointModeBtn" style="display:none;">Waypoint Mode</button>
            <!-- Waypoint navigation -->
            <button class="tool-button nav-mode-btn" id="walkModeBtn" style="display:none;">Walk Mode</button>
            <!-- Walk navigation     -->
            <button class="tool-button nav-mode-btn" id="orbitModeBtn" style="display:none;">Orbit Mode</button>
            <!-- Orbit navigation    -->
            <button class="tool-button nav-mode-btn" id="flyModeBtn" style="display:none;">Fly Mode</button>
            <!-- Fly navigation      -->

            <label style="margin-top: 20px; margin-bottom: 10px;">Visual Effects</label>
            <button class="tool-button" id="ssaoToggleBtn">Toggle SSAO</button> <!-- Toggle SSAO effect     -->
            <button class="tool-button" id="furnishingsToggleBtn">Furnishings: ON</button>
            <!-- Toggle furnishings visibility -->

            <label for="sunTimeSlider" style="margin-top: 20px;">Sun Time Control</label>
            <input type="range" id="sunTimeSlider" min="9" max="15" step="0.1" value="11"
                style="width:100%; margin-top:5px;"> <!-- Time of day slider     -->
            <p id="sunTimeDisplay">11:00</p> <!-- Current time display   -->
        </div>
        <!-- ---------------------------------------------------------------- -->

        <!-- ----------------------------------------------------------------- -->
        <!-- UI MENU | Main 3D Rendering Canvas Container                     -->
        <!-- ----------------------------------------------------------------- -->
        <div id="canvas-container">
            <canvas id="renderCanvas"></canvas> <!-- Babylon.js render target -->
        </div>
        <!-- ---------------------------------------------------------------- -->

        <!-- ----------------------------------------------------------------- -->
        <!-- UI MENU | Loading State Overlay with Progress Indicator          -->
        <!-- ----------------------------------------------------------------- -->
        <div id="loading-overlay">
            <div class="spinner" id="loading-spinner"></div> <!-- Animated loading spinner -->
            <p id="loading-status">Loading Your Vision… Please Wait</p> <!-- Loading status message   -->
            <div class="loading-progress-container">
                <div class="loading-progress-bar" id="loading-progress"></div> <!-- Progress bar -->
            </div>
        </div>
        <!-- ---------------------------------------------------------------- -->

        <!-- ----------------------------------------------------------------- -->
        <!-- UI MENU | Error Message Display for Failed Operations            -->
        <!-- ----------------------------------------------------------------- -->
        <div id="error-message">
            Failed to load the 3D model. Please check the file URL or try again later. <!-- Error notification text -->
        </div>
        <!-- ---------------------------------------------------------------- -->

        <!-- ----------------------------------------------------------------- -->
        <!-- UI MENU | Application Footer with Copyright Information          -->
        <!-- ----------------------------------------------------------------- -->
        <div id="footer">
            © 2025 Noble Architecture | All Rights Reserved <!-- Copyright notice -->
        </div>
        <!-- ---------------------------------------------------------------- -->

    </div>
    <!-- endregion ----------------------------------------------------------------- -->


    <!-- ----------------------------------------------------------------- -->
    <!-- REGION | Application Ready - All Core Modules Loaded                -->
    <!-- ----------------------------------------------------------------- -->
    <!-- 
    All TrueVision3D application logic has been modularized into separate files:
    - SceneConfig_SolarOrientationControlLogic.js: Solar positioning and lighting calculations
    - RenderingPipeline_TrueVision3DCore.js: 3D scene creation and rendering management  
    - ApplicationCore_TrueVision3DManager.js: Application initialization and coordination
    
    The ApplicationCore_TrueVision3DManager.js automatically initializes when DOM is ready.
    -->
    <!-- endregion ----------------------------------------------------------------- -->

    <!-- ----------------------------------------------------------------- -->
    <!-- DEBUGGING SCRIPT | Add this temporarily before closing </body>   -->
    <!-- ----------------------------------------------------------------- -->
    <script>
        // DEBUGGING SCRIPT - Add before closing </body> tag
        window.addEventListener('DOMContentLoaded', function () {
            console.log("🔍 DEBUG: DOM Content Loaded");

            // CHECK NAMESPACE
            console.log("🔍 DEBUG: TrueVision3D namespace:", window.TrueVision3D);

            // CHECK MATERIAL LOGIC
            if (window.TrueVision3D && window.TrueVision3D.MaterialLogic) {
                console.log("✅ DEBUG: MaterialLogic module found");
                console.log("🔍 DEBUG: MaterialLogic methods:", Object.keys(window.TrueVision3D.MaterialLogic));
            } else {
                console.error("❌ DEBUG: MaterialLogic module NOT found");
            }

            // CHECK CONFIG LOADING
            if (window.TrueVision3D && window.TrueVision3D.configLoadPromise) {
                console.log("🔍 DEBUG: Config loading...");
                window.TrueVision3D.configLoadPromise.then(success => {
                    console.log("🔍 DEBUG: Config loaded:", success);
                    if (success && window.TrueVision3D.AppConfig) {
                        console.log("✅ DEBUG: App configuration available");
                    } else {
                        console.error("❌ DEBUG: App configuration failed or missing");
                    }
                }).catch(error => {
                    console.error("❌ DEBUG: Config loading error:", error);
                });
            } else {
                console.error("❌ DEBUG: configLoadPromise not found");
            }

            // CHECK BABYLON.JS
            if (typeof BABYLON !== 'undefined') {
                console.log("✅ DEBUG: Babylon.js loaded");
            } else {
                console.error("❌ DEBUG: Babylon.js NOT loaded");
            }

            // CHECK ALL SCRIPT MODULES
            setTimeout(() => {
                console.log("🔍 DEBUG: Checking all modules after 1 second...");

                const modules = [
                    'TrueVision3D.MaterialLogic',
                    'TrueVision3D.SceneConfig.HdriLightingLogic',
                    'TrueVision3D.RenderingPipeline',
                    'TrueVision3D.RenderEffects.SsaoAmbientOcclusionEffect'
                ];

                modules.forEach(modulePath => {
                    const module = modulePath.split('.').reduce((obj, prop) => obj && obj[prop], window);
                    if (module) {
                        console.log(`✅ DEBUG: ${modulePath} loaded`);
                    } else {
                        console.error(`❌ DEBUG: ${modulePath} NOT loaded`);
                    }
                });
            }, 1000);
        });

        // CATCH ALL ERRORS
        window.addEventListener('error', function (event) {
            console.error("🚨 DEBUG: Global error caught:", event.error);
            console.error("🚨 DEBUG: Error in file:", event.filename, "line:", event.lineno);
        });

        // CATCH UNHANDLED PROMISE REJECTIONS
        window.addEventListener('unhandledrejection', function (event) {
            console.error("🚨 DEBUG: Unhandled promise rejection:", event.reason);
        });

        // FURNITURE TOGGLE DEBUG UTILITIES
        // Add these functions to the global scope for easy console testing
        window.debugFurnitureToggle = function () {
            console.log("=== FURNITURE TOGGLE DEBUG UTILITIES ===");
            console.log("Available debug functions:");
            console.log("- window.testFurnitureToggle() - Test the furniture toggle");
            console.log("- window.inspectFurnitureState() - Inspect current furniture state");
            console.log("- window.forceFurnitureToggle() - Force toggle via direct pipeline access");
        };

        window.testFurnitureToggle = function () {
            console.log("=== TESTING FURNITURE TOGGLE ===");

            // 1. CHECK BUTTON
            const button = document.getElementById("furnishingsToggleBtn");
            console.log("1. Button found:", !!button);
            if (button) {
                console.log("   Button text:", button.textContent);
                console.log("   Button onclick:", !!button.onclick);
                console.log("   Button listeners:", getEventListeners ? getEventListeners(button) : "getEventListeners not available");
            }

            // 2. CHECK APPLICATION CORE
            console.log("2. ApplicationCore available:", !!window.TrueVision3D?.ApplicationCore);

            // 3. CHECK RENDERING PIPELINE
            console.log("3. RenderingPipeline available:", !!window.TrueVision3D?.RenderingPipeline);
            if (window.TrueVision3D?.RenderingPipeline) {
                console.log("   Toggle method available:", !!window.TrueVision3D.RenderingPipeline.toggleFurnishings);
                console.log("   Get visibility method available:", !!window.TrueVision3D.RenderingPipeline.getFurnishingsVisibility);
            }

            // 4. TEST BUTTON CLICK
            if (button) {
                console.log("4. Testing button click...");
                button.click();
                console.log("   Button click completed");
            } else {
                console.log("4. Cannot test button click - button not found");
            }
        };

        window.inspectFurnitureState = function () {
            console.log("=== FURNITURE STATE INSPECTION ===");

            if (window.TrueVision3D?.RenderingPipeline?.getFurnishingsVisibility) {
                const isVisible = window.TrueVision3D.RenderingPipeline.getFurnishingsVisibility();
                console.log("Current furniture visibility:", isVisible);
            }

            // Check core references
            if (window.TrueVision3D?.ApplicationCore?.getCoreReferences) {
                const refs = window.TrueVision3D.ApplicationCore.getCoreReferences();
                if (refs?.scene) {
                    const totalMeshes = refs.scene.meshes.length;
                    console.log("Total scene meshes:", totalMeshes);

                    // Look for furniture-like meshes
                    const potentialFurniture = refs.scene.meshes.filter(m =>
                        m.name && (
                            m.name.toLowerCase().includes('furniture') ||
                            m.name.toLowerCase().includes('furnishing') ||
                            m.name.toLowerCase().includes('chair') ||
                            m.name.toLowerCase().includes('table') ||
                            m.name.toLowerCase().includes('bed') ||
                            m.name.toLowerCase().includes('sofa') ||
                            m.name.toLowerCase().includes('cabinet')
                        )
                    );
                    console.log("Potential furniture meshes found:", potentialFurniture.length);
                    if (potentialFurniture.length > 0) {
                        console.log("Sample furniture mesh names:", potentialFurniture.slice(0, 5).map(m => m.name));
                    }
                }
            }
        };

        window.forceFurnitureToggle = function () {
            console.log("=== FORCE FURNITURE TOGGLE ===");

            if (window.TrueVision3D?.RenderingPipeline?.toggleFurnishings) {
                try {
                    const result = window.TrueVision3D.RenderingPipeline.toggleFurnishings();
                    console.log("✅ Force toggle successful, new state:", result);

                    // Update button manually
                    const button = document.getElementById("furnishingsToggleBtn");
                    if (button) {
                        button.textContent = result ? "Furnishings: ON" : "Furnishings: OFF";
                        button.style.backgroundColor = result ? "#4CAF50" : "#666";
                        console.log("✅ Button updated manually");
                    }
                } catch (error) {
                    console.error("❌ Force toggle failed:", error);
                }
            } else {
                console.error("❌ RenderingPipeline.toggleFurnishings not available");
            }
        };

        // AUTO-REGISTER DEBUG UTILITIES AFTER DOM LOAD
        setTimeout(() => {
            if (window.debugFurnitureToggle) {
                console.log("🔧 Furniture debug utilities ready! Type 'debugFurnitureToggle()' in console for help.");
            }
        }, 2000);

        // FINAL DEBUG: Test furniture toggle functionality
        window.testFurnitureSystem = function () {
            console.log("=== FURNITURE SYSTEM TEST ===");

            // 1. Check rendering pipeline
            if (!window.TrueVision3D?.RenderingPipeline) {
                console.error("❌ Rendering pipeline not available");
                return;
            }

            // 2. Get furniture status
            if (window.TrueVision3D.RenderingPipeline.getFurnitureStatus) {
                console.log("\n📊 Current Status:");
                window.TrueVision3D.RenderingPipeline.getFurnitureStatus();
            }

            // 3. Test toggle
            console.log("\n🔄 Testing toggle...");
            const before = window.TrueVision3D.RenderingPipeline.getFurnishingsVisibility();
            const after = window.TrueVision3D.RenderingPipeline.toggleFurnishings();
            console.log(`Toggle result: ${before} → ${after}`);

            // 4. Check button state
            const button = document.getElementById("furnishingsToggleBtn");
            if (button) {
                console.log(`\n🔘 Button state:`);
                console.log(`  Text: "${button.textContent}"`);
                console.log(`  Color: ${button.style.backgroundColor}`);
            }

            // 5. Manual visibility check
            const refs = window.TrueVision3D.RenderingPipeline.getCoreReferences();
            if (refs?.scene) {
                const visibleCount = refs.scene.meshes.filter(m => m.isVisible).length;
                console.log(`\n👁️ Total visible meshes in scene: ${visibleCount}`);
            }

            return { before, after, success: before !== after };
        };
    </script>
    <!-- endregion ----------------------------------------------------------------- -->

</body>

</html>